# Задача: Разработка страницы "Мозаика" (mosaicwall.html)

## Описание задачи

Необходимо реализовать страницу для одновременного просмотра нескольких видеопотоков в виде настраиваемой мозаики. Пользователь самостоятельно формирует состав и порядок отображаемых каналов путём перетаскивания из боковой панели. Layouts сохраняются в localStorage и доступны через выпадающее меню закладок.

## Бизнес-требования

Страница предназначена для:
- Одновременного визуального контроля нескольких каналов вещания
- Гибкой настройки состава мозаики без перезагрузки страницы
- Сохранения и быстрого восстановления часто используемых наборов каналов
- Полноэкранного просмотра отдельного потока без выхода со страницы

## Макет

**Файл:** `pages/mosaicwall.html`
**Связанная документация:** `context/105_mosaicwall.md`

---

## 1. Компоненты страницы

### 1.1 Общая компоновка

Страница делится на две зоны: левая панель (список каналов) и правая рабочая область (плееры + тулбар).

```
┌──────┬──────────────────────────────────────────────┐
│Side  │  [Toolbar: Закладки | Очистить]               │
│bar   ├──────────────────────────────────────────────┤
│      │                                               │
│[◀]   │  [Player 1] [Player 2] [Player 3]            │
│      │  [Player 4] [Player 5]                        │
│Панель│                                               │
│каналов│  (drop zone hint если плееров нет)           │
└──────┴──────────────────────────────────────────────┘
```

Главный контент сдвинут вправо на 72px (ширина sidebar). Левая панель каналов фиксирована поверх рабочей зоны.

---

### 1.2 Левая панель каналов (.channel-panel)

**Ширина:** 260px
**Позиционирование:** fixed, слева от рабочей области (left: 72px)

#### Состояния панели

| Состояние | Поведение |
|-----------|-----------|
| Развёрнута | Ширина 260px, кнопка `◀` |
| Свёрнута | Ширина 0px, кнопка `▶` (кнопка остаётся видимой) |

Переключение анимируется (transition: width 0.3s ease).

#### Поиск каналов

- **Тип:** Text input
- **Placeholder:** "Поиск канала..."
- **Поведение:** Фильтрация таблицы каналов в реальном времени по полю `name` (без debounce)
- **Сброс:** При очистке поля отображаются все каналы (с учётом активных тег-фильтров)

#### Фильтрация по тегам

Строка чипов над таблицей:

| Чип | Логика | Цвет (активный) |
|-----|--------|-----------------|
| Все | Сбрасывает фильтр (Set пуст) | accent-primary (#00ff88) |
| HLS | Показывает каналы с тегом HLS | #ffaa00 |
| Live | Показывает каналы с тегом Live | #00ff88 |
| MPEG-TS | Показывает каналы с тегом MPEG-TS | #00ccff |
| VOD | Показывает каналы с тегом VOD | text-secondary |

**Логика:** OR — канал отображается, если он содержит **хотя бы один** из активных тегов.
**Мультиселект:** Можно активировать несколько тегов одновременно. Кнопка "Все" сбрасывает все активные теги.

#### Таблица каналов

Таблица с двумя колонками и фиксированной высотой строк (36px):

| Колонка | Содержимое | Ширина |
|---------|-----------|--------|
| Название | Имя канала (font-weight: 600) + иконка статуса | ~65% |
| Теги | Теги-бейджи канала (nowrap, overflow hidden) | ~35% |

**Заголовок таблицы:** sticky (position: sticky; top: 0), фон bg-tertiary.

**Статусы каналов** (цветная точка перед названием):

| Статус | Цвет | Значение |
|--------|------|---------|
| online | #00ff88 (зелёный) | Канал работает |
| warning | #ffaa00 (оранжевый) | Нестабильный сигнал |
| offline | #4b5563 (серый) | Канал недоступен |

**Drag & Drop из таблицы:**
- Строка `draggable="true"`
- `dragstart` → сохраняет `channelId` в `event.dataTransfer`
- Визуальная обратная связь: строка получает класс `.dragging` (opacity: 0.5) во время перетаскивания

---

### 1.3 Тулбар (.mosaic-toolbar)

Фиксирован в верхней части рабочей зоны. Состав (слева направо):

| Элемент | Тип | Поведение |
|---------|-----|-----------|
| Заголовок "Мозаика" | Текст (h2, 18px) | Статичный |
| Dropdown "Закладки" | Кнопка + меню | Управление сохранёнными раскладками |
| Кнопка "Очистить всё" | btn-secondary | Удаляет все плееры из сетки |

#### Dropdown закладок

**Открытие:** Клик на кнопку "Закладки ▾"
**Закрытие:** Клик вне области dropdown

**Содержимое dropdown:**
1. Список сохранённых раскладок (имя + дата сохранения)
2. Разделитель
3. Поле ввода имени + кнопка "Сохранить текущую"

**Действия над раскладкой:**
- **Клик по имени** → загружает раскладку (удаляет текущие плееры, создаёт новые по сохранённым channelId)
- **Кнопка "×"** → удаляет раскладку из localStorage (с подтверждением не требуется)

**Структура localStorage (`monix_layouts`):**
```json
[
  {
    "name": "Утренний эфир",
    "channels": [1, 3, 7],
    "ts": 1710000000000
  }
]
```

**Ограничения:** Нельзя сохранить раскладку с пустым именем; нельзя сохранить пустую мозаику (0 плееров).

---

### 1.4 Сетка плееров (.player-grid)

**CSS Grid:** `grid-template-columns: repeat(auto-fill, minmax(300px, 1fr))`
**Gap:** 12px
**Overflow:** auto (вертикальная прокрутка при большом количестве плееров)

**Drop zone (пустая сетка):**
- Отображает hint-текст: "Перетащите канал из списка слева"
- Hint исчезает при добавлении первого плеера
- Вся область сетки является зоной сброса (`dragover` + `drop`)

**Один и тот же канал** может быть добавлен в мозаику несколько раз (разные экземпляры плеера с уникальным `player.id`).

---

### 1.5 Ячейка плеера (.player-cell)

**Соотношение сторон:** 16:9 (через `aspect-ratio: 16/9`)
**Оформление:** Имитация видеопотока — уникальный radial-gradient по цвету канала + псевдоэлемент `::after` с scanlines-паттерном.

#### Структура ячейки

```
┌─────────────────────────────────┐
│ [●] Название канала    [≡] [⛶] │  <- .player-header
│─────────────────────────────────│
│                                 │
│   (имитация видеопотока)        │  <- визуальный фон
│                                 │
└─────────────────────────────────┘
```

**Заголовок (.player-header):**

| Элемент | Описание |
|---------|----------|
| Цветная точка | Цвет соответствует `channel.color` |
| Название канала | Имя из массива CHANNELS |
| Кнопка удаления `×` | Удаляет этот экземпляр плеера из сетки |
| Кнопка полноэкранного режима `⛶` | Открывает fullscreen-оверлей |

**Hover на ячейке:** Заголовок становится видимым (opacity: 1), добавляется рамка цвета канала.

---

### 1.6 Полноэкранный оверлей (.fullscreen-overlay)

**Триггер:** Кнопка `⛶` в заголовке плеера
**Закрытие:** Кнопка `✕` или клавиша `Escape`

**Структура оверлея:**
```
┌──────────────────────────────────────────┐
│ [●] Название канала              [✕]     │  <- заголовок
│──────────────────────────────────────────│
│                                          │
│         (увеличенный видеопоток)         │
│                                          │
└──────────────────────────────────────────┘
```

- Overlay занимает весь viewport (position: fixed, inset: 0)
- z-index: 1000
- Фон: rgba(0,0,0,0.95)
- Анимация появления: scale 0.97 → 1, opacity 0 → 1 (0.2s)
- Клавиша Escape закрывает оверлей (обработчик `keydown` добавляется при открытии и удаляется при закрытии)

---

## 2. Данные каналов (Mock)

Массив `CHANNELS` в JS-коде страницы:

| id | Название | Теги | Статус | Цвет |
|----|----------|------|--------|------|
| 1 | TV Channel 1 — Main Feed | HLS, Live | online | #00ff88 |
| 2 | TV Channel 2 — Sports | HLS, Live | online | #00ccff |
| 3 | Radio Stream — FM 101.5 | MPEG-TS, Live | online | #a78bfa |
| 4 | Test Stream — QA | HLS, Live, VOD | warning | #ffaa00 |
| 5 | Backup Feed — Channel 1 | MPEG-TS | offline | #8b94a8 |
| 6 | Dev Environment Stream | HLS, VOD | offline | #fb923c |
| 7 | TV Channel 3 — News 24/7 | HLS, Live | online | #f472b6 |
| 8 | IPTV Multicast — Region A | MPEG-TS, Live | online | #60a5fa |

---

## 3. Дизайн-система и стилевые параметры

### 3.1 CSS-переменные (Dark Theme)

```css
--bg-primary: #0a0e1a;
--bg-secondary: #111827;
--bg-tertiary: #1a2332;
--accent-primary: #00ff88;
--accent-secondary: #00ccff;
--accent-warning: #ffaa00;
--text-primary: #e4e8f0;
--text-secondary: #8b94a8;
--border-color: #1f2937;
```

### 3.2 Ключевые размеры

| Элемент | Значение |
|---------|----------|
| Sidebar | 72px |
| Панель каналов (развёрнута) | 260px |
| Панель каналов (свёрнута) | 0px |
| Минимальная ширина плеера | 300px |
| Высота строки таблицы каналов | 36px |
| Высота тулбара | 60px |
| Соотношение сторон плеера | 16:9 |

### 3.3 Z-index карта

| Z-index | Элемент |
|---------|---------|
| 100 | Sidebar |
| 200 | Панель каналов (.channel-panel) |
| 300 | Тулбар (.mosaic-toolbar) |
| 400 | Dropdown закладок |
| 1000 | Fullscreen-оверлей |

---

## 4. Технические требования

### 4.1 HTML-структура

```html
<aside class="sidebar"></aside>
<div class="channel-panel" id="channelPanel">
  <!-- toggle button, search, tag chips, table -->
</div>
<div class="main-content">
  <div class="mosaic-toolbar"><!-- ... --></div>
  <div class="player-grid" id="playerGrid"><!-- player cells --></div>
</div>
<div class="fullscreen-overlay" id="fullscreenOverlay"><!-- ... --></div>
<script src="../components/sidebar.js"></script>
```

### 4.2 JavaScript — ключевые структуры данных

```js
// Массив активных каналов в сетке
let players = []; // [{ id: uniqueId, channelId: number }]

// Мультиселект тег-фильтра
let activeTags = new Set(); // пустой Set = "Все"

// Идентификатор следующего плеера
let nextPlayerId = 1;
```

### 4.3 JavaScript — ключевые функции

| Функция | Назначение |
|---------|-----------|
| `renderChannels()` | Перерисовка таблицы каналов с учётом поиска и тег-фильтра |
| `addPlayer(channelId)` | Добавление плеера в сетку (создание DOM-ячейки) |
| `removePlayer(playerId)` | Удаление конкретного плеера из `players[]` и DOM |
| `clearAll()` | Очистка всей сетки плееров |
| `openFullscreen(channelId)` | Открытие fullscreen-оверлея для канала |
| `closeFullscreen()` | Закрытие оверлея, удаление слушателя Escape |
| `saveLayout(name)` | Сохранение текущих `players[].channelId` в localStorage |
| `loadLayout(layout)` | Восстановление раскладки — `clearAll()` + `addPlayer()` для каждого channelId |
| `deleteLayout(index)` | Удаление раскладки из массива в localStorage |
| `renderBookmarks()` | Перерисовка списка раскладок в dropdown |
| `syncChipStyles()` | Обновление классов активности тег-чипов (`.active`, цвета) |
| `togglePanel()` | Переключение состояния панели каналов (collapsed/expanded) |

### 4.4 Drag & Drop

```
dragstart (строка таблицы) → dataTransfer.setData('channelId', id)
dragover (player-grid)     → preventDefault() — разрешить сброс
drop (player-grid)         → addPlayer(channelId)
dragend (строка таблицы)   → снять класс .dragging
```

### 4.5 Персистентность

- **Ключ localStorage:** `monix_layouts`
- **Формат:** JSON-массив объектов `{ name, channels: number[], ts: timestamp }`
- **Чтение:** При открытии `renderBookmarks()` загружает список из localStorage
- **Запись:** При каждом `saveLayout()` / `deleteLayout()`

---

## 5. Критерии приёмки (Definition of Done)

### Функциональность:
- ✅ Drag & Drop канала из таблицы в сетку работает
- ✅ Один канал можно добавить несколько раз
- ✅ Кнопка `×` удаляет конкретный плеер
- ✅ "Очистить всё" удаляет все плееры
- ✅ Поиск фильтрует список каналов по имени
- ✅ Тег-фильтр работает в режиме мультиселект с OR-логикой
- ✅ "Все" сбрасывает тег-фильтр
- ✅ Fullscreen-оверлей открывается и закрывается (кнопка + Escape)
- ✅ Сохранение раскладки с именем записывается в localStorage
- ✅ Загрузка раскладки заменяет текущую мозаику
- ✅ Удаление раскладки убирает её из dropdown и localStorage
- ✅ Панель каналов сворачивается/разворачивается с анимацией

### Визуал и UX:
- ✅ Hint "Перетащите канал" виден при пустой сетке и скрыт при наличии плееров
- ✅ Строки таблицы одинаковой высоты (36px)
- ✅ Теги в строке не переносятся (nowrap)
- ✅ Имитация видеопотока уникальна для каждого канала (свой цвет градиента)
- ✅ Заголовок плеера показывается при hover
- ✅ Все цвета соответствуют CSS-переменным dark theme
- ✅ Активные тег-чипы подсвечены своим цветом

### Техническая реализация:
- ✅ Вся логика страницы в IIFE
- ✅ Sidebar подключён как внешний компонент
- ✅ Нет глобальных переменных (кроме массива CHANNELS)
- ✅ Нет ошибок в консоли браузера
- ✅ localStorage не блокирует работу при отсутствии данных

---

## 6. Файлы и зависимости

**Основной файл:**
- `pages/mosaicwall.html`

**Зависимости:**
- `components/sidebar.css`
- `components/sidebar.js`

**Связанная документация:**
- `context/105_mosaicwall.md` — подробная UX-документация страницы
- `context/101_object-set.md` — концепция объектов мониторинга (данные каналов)

---

## 7. Примечания для разработчика

1. **Drag & Drop:** `dragover` обязательно должен вызывать `event.preventDefault()`, иначе событие `drop` не сработает.

2. **Один канал — несколько экземпляров:** Идентификатор плеера (`player.id`) и идентификатор канала (`player.channelId`) — разные сущности. `player.id` уникален для каждого экземпляра в сетке, `channelId` может повторяться.

3. **Fullscreen-оверлей:** Слушатель `keydown` для Escape должен добавляться при открытии оверлея и удаляться при закрытии, чтобы не накапливаться при многократном открытии.

4. **Загрузка раскладки:** При загрузке раскладки текущие плееры полностью заменяются — не обновляются инкрементально. Это упрощает реализацию и достаточно для MVP.

5. **Тег-фильтр и поиск работают вместе:** Канал отображается, если он удовлетворяет **обоим** условиям (AND между поиском и тег-фильтром).

6. **Имитация видео:** Используйте `radial-gradient` с уникальными цветами каналов. Scanlines-эффект через псевдоэлемент `::after` с `repeating-linear-gradient` — добавляет ощущение реального видеосигнала без нагрузки на производительность.

7. **Панель каналов поверх контента:** `position: fixed` с `z-index: 200` — панель перекрывает сетку плееров при развёрнутом состоянии, рабочая зона не должна иметь `padding-left` под панель.

---

## 8. Вопросы для уточнения

- Нужна ли синхронизация раскладок между вкладками/сессиями (через BroadcastChannel или серверное хранилище)?
- Должны ли плееры подключаться к реальным потокам (через `<video>` + HLS.js/hls.js) или оставаться визуальной имитацией?
- Нужно ли ограничивать максимальное количество плееров в сетке?
- Должна ли мозаика поддерживать drag-to-reorder (изменение порядка плееров внутри сетки)?

---

**Приоритет:** High
**Оценка:** 8 SP (Story Points)
**Метки:** frontend, ui, monitoring, video, drag-and-drop
